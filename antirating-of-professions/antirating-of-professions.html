<script>
    // Взрослая версия
    // Перекидываем на конец теста если есть значение
    if (localStorage.getItem("test-end")) {
        location.href = "../testing-end?test-name=antiratingOfProfessions"
    }
</script>

<script>
    // Меняем название страницы
    document.title = "Антирейтинг профессий"

    // Если нету manager-id В ссылке то перекинет на страницу с просьбой получить актуальную ссылку
    let URLParams = Object.fromEntries(new URLSearchParams(window.location.search))
    // Если в строке нету значения manager-id или он не цифра или значение пустое
    if (!URLParams.hasOwnProperty("manager-id") || isNaN(URLParams["manager-id"]) || URLParams["manager-id"] === "") {
        location.href = "../testing-end?no-manager-id=true"
    }

    // Получем сохраненные данные о тестировании
    let questionsHash = JSON.parse(localStorage.getItem("questionsHash_antiratingOfProfessions"))
    let isQuestionsHash = questionsHash ? true : false // Была ли информация взята из кэша

    // Если объект = null - делаем его пустым объектом
    if (!isQuestionsHash) {
        questionsHash = {}
    }
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    :root {
        --p-gray: #00000088;
        --p-cian: #66CAA5;
        --h-title: #BD92CE;

        --border: #BD92CE;
        --border-cian: #66CAA6;
        --button: #BD92CE;
        --input-bg: #DEC8E7;
        --input-placeholder: #5E4967;

        --dot-bg: #F1CD21;


        --progress-width: 100%;
    }
    
    body {
        width: 100%;
    }
    
    h2 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 500;
        font-size: 48px;
        line-height: 134%;
    }
    
    h3 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 500;
        font-size: 24px;
        line-height: 132%;
    }
    
    p, .p1 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 400;
        font-size: 20px; /* На этой странице 20 вместо 18 */
        line-height: 21px;
    }

    .p1-strong {
        font-family: 'Roboto';
        font-weight: 500;
        font-size: 18px;
        line-height: 112%;
    }

    .p-gray {
        color: var(--p-gray);
    }

    .p-cut {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .hidden {
        display: none !important;
    }


    /* Стиль для ошибки инпута */
    input.error {
        animation: inputError 2s ease-in;
    }

    /* Анимацция ошибки */
    @keyframes inputError {
        0% {
            border: 1px solid var(--border);
        }

        2% {
            border: 1px solid #F40B0B;
        }

        100% {
            border: 1px solid var(--border);
        }
    }
</style>

<style>
    /* Логотип сверху слево */
    #top-left-logo {
        width: 128px;
        
        position: absolute;
        top: 50px;
        left: 100px;
        
    }
    
    #top-left-logo img {
        width: 100%;
    }
</style>
    
<style>
    article {
        width: min(1440px, 100%); /* Ширина 1440px или 100% при сужении */
        height: 800px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        position: relative;
        
        margin: 0 auto; /* По центру страницы */
    }
    
    
    #form-aside {
        width: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
        gap: 12px;
    }


    #form-aside h3 {
        width: 403px;
        height: 96px;

        margin-right: 126px;
    }

    #form-aside p {
        width: 403px;
        height: 154px;

        font-size: 20px;
        line-height: 112%;

        margin-right: 126px;
    }

    #form-aside h3 span, #form-aside p span {
        color: var(--p-cian);
    }
</style>

<style>
    #form-section {
        width: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    #form-section form {
        width: 460px;
        box-sizing: border-box;
        padding: 42px 65px;

        display: flex;
        flex-direction: column;
    
        border: 1px solid var(--border);
        border-radius: 10px;

        margin-left: 67px;
    }


    #form-logo {
        width: 100%;
        height: 29px;
        display: flex;
        justify-content: center;

        margin-bottom: 42px;
    }
    
    #form-logo img {
        width: 39px;
        height: 29px;
    }


    form input {
        display: block;
        width: 100%;
        height: 40px;
        box-sizing: border-box;
        padding: 0 12px;

        border: 1px solid var(--border);
        border-radius: 10px;

        margin-top: 4px;
        margin-bottom: 29px;
    }

    #form-error {
        color: #F40B0B;
        margin-bottom: 12px;
        visibility: hidden;
    }

    #form-error.show {
        visibility: visible;
    }

    button {
        width: 100%;
        height: 40px;
        box-sizing: border-box;

        font-size: 18px !important;

        display: flex;
        justify-content: center;
        align-items: center;

        background: var(--button);
        border-radius: 10px;
        border: none;
        outline: none;       
        
        transition: .15s all;
        cursor: pointer;
        color: #000000 !important;
    }
    
    @media (hover: hover) {
        button:hover {
            background: #000000;
            color: #FFFFFF !important;
        }
    }
    
    button:disabled {
        background: #d1aedf;
        color: #313131 !important;
        cursor: not-allowed;
    }
</style>

<style>
    input[type="email"] {
        margin-bottom: 12px;
    }


    /* Обработка персональной информации */
    .form-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 12px;

        margin-bottom: 20px;
    }

    #label-policy {
        width: calc(100% - 12px - 15px);
        font-size: 12px;
        line-height: 112%;
        cursor: pointer;
    }

    #label-policy span {
        font-size: 12px;
        line-height: 112%;
        cursor: pointer;
        display: inline;

        font-weight: 500;
        color: var(--h-title);
    }

    @media (hover: hover) {
        #label-policy span:hover {
            text-decoration: underline;
        }
    }

    @media (hover: none) {
        #label-policy span {
            text-decoration: underline;
        }
    }

    #policy {
        width: 15px;
        height: 15px;
        box-sizing: border-box;
        cursor: pointer;

        border-radius: 3px;
        border: 1px solid var(--border);
        background-color: #ffffff;

    }

    #policy.checked {
        background-color: var(--border);
    }
</style>

<style>
    .article-content {
        height: auto;
        flex-direction: column;
        position: relative;

        box-sizing: border-box;
        padding: 0 80px 70px 80px; /* На 70px снизу меньше так как снизу плашка от тильды */
    }


    #section-content {
        width: 100%;
        height: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 40px;

        margin-top: 88px;
    }


    /* Заголовок страницы */
    #section-title {
        width: 100%;
        height: 62px;
        position: relative;

        margin-top: 145px;

    }

    #section-title h2 {
        position: absolute;
        top: 0;
        left: 24px;

        color: #141212;
        font-weight: 400;
        text-transform: uppercase;
        z-index: 2;
    }

    #title-bg {
        width: 697px;
        height: 29px;
        position: absolute;
        bottom: 0;
        left: 8px;

        box-sizing: border-box;
        border-radius: 30px;
        background: var(--p-cian);
        box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25);
        z-index: 1;
    }

    .section-content__row {
        width: 100%;
        display: flex;
        gap: 20px;
    }


    .section-content__row:nth-of-type(3) .section-content__row-image {
        margin-top: 8px;
    }

    .section-content__row:nth-of-type(4) .section-content__row-image {
        margin-top: 8px;
    }

    .section-content__row-image {
        width: 50px;
        height: 50px;
    }

    .section-content__row-text {
        color: #141212;
        font-weight: 400;
    }

    .section-content__row-text span {
        font-weight: 700;
    }

    
    .section-content-block {
        width: 100%;

        box-sizing: border-box;
        padding: 40px;

        border-radius: 20px;
        border: 2px solid var(--border-cian);

        overflow: hidden;
    }

    .section-content-block h3 {
        color: #141212;
        font-weight: 400;
    }

    
    .section-inputs {
        width: 100%;
        height: 1160px;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
        gap: 40px 80px;

        margin-top: 46px;
    }
    
    .section-inputs__block {
        width: calc(50% - 20px);
        height: 200px;

        position: relative;
    }

    .section-inputs__block h3 {
        position: absolute;
        top: 20px;
        left: 20px;

        font-size: 32px;
        font-weight: 500;
    }

    .section-inputs__block textarea {
        width: 100%;
        height: 100%;
        resize: none;

        box-sizing: border-box;
        padding-left: 80px;
        padding-top: 32px;
        border-radius: 20px;
        border: 2px solid var(--border);

        font-family: 'Roboto', Sans-Serif;
        font-weight: 400;
        font-size: 24px;
        line-height: 21px;
    }

    .section-inputs__block textarea::-webkit-scrollbar {
        display: none;
    }

    #button-end, #button-back {
        width: 720px;
        height: 80px;

        border-radius: 20px;

        font-size: 32px !important;
        font-weight: 500;
    }

    #button-end {
        margin-top: 40px;
    }
</style>

<article>
    <div id="top-left-logo">
        <img src="https://static.tildacdn.com/tild6630-3237-4638-a534-313664333931/___.svg" alt="logo">
    </div>
    
    <aside id="form-aside">
        <h3>После заполнения анкеты вам откроется доступ к диагностике<br><span>«Антирейтинг профессий»</span></h3>
        <p>Диагностика поможет узнать, какие виды деятельности вам подходят больше всего.<br>Пожалуйста, внимательно прочитайте инструкцию, прежде чем переходить к самой диагностике. Инструкция будет доступна вам после заполнения данной формы.</p>
    </aside>

    <section id="form-section">
        <form>
            <div id="form-logo">
                <img src="https://sun9-33.userapi.com/impg/o7UasFLuPHffAw7M354dhIyAw-ywr1TdpgWp7w/AU35d9CQutY.jpg?size=192x140&quality=96&sign=65f29d920ee520f801e55492621ceaed&type=album" alt="mini-logo">
            </div>

            <label class="p1" for="form-name">ФИО</label>
            <input class="p1" type="text" id="form-name" name="form-name" maxlength="100" required>

            <label class="p1" for="form-phone">Телефон</label>
            <input class="p1" type="tel" id="form-phone" name="form-phone" maxlength="20" required>

            <label class="p1" for="form-email">Email</label>
            <input class="p1" type="email" id="form-email" name="form-email" maxlength="100" required>

            <p id="form-error">Неверный формат ФИО</p>

            <div class="form-checkbox">
                <div id="policy"></div>
                <label id="label-policy" for="policy" class="p1">Я принимаю условия <span>Пользовательского соглашения</span> и даю свое <span>согласие на обработку персональных данных</span> в соответствии с <span>Политикой</span>.</label>
            </div>
            

            <button class="p1" type="submit" id="submit-form">Далее</button>
        </form>
    </section>


    <!-- Контент диагностики -->
    <div id="section-title" class="hidden">
        <h2>«Антирейтинг профессий»</h2>
        <div id="title-bg"></div>
    </div>
    <section id="section-content" class="hidden">
        <div class="section-content__row">
            <div class="section-content__row-image">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 50 50" fill="none">
                    <path d="M20.0118 9.84375C20.0118 15.0084 15.8636 19.1875 10.7559 19.1875C5.64823 19.1875 1.5 15.0084 1.5 9.84375C1.5 4.6791 5.64823 0.5 10.7559 0.5C15.8636 0.5 20.0118 4.6791 20.0118 9.84375Z" fill="#BD92CE" stroke="#BD92CE"/>
                    <rect x="30.7695" y="0.5" width="18.5118" height="19" rx="1.5" stroke="#66CAA5"/>
                    <path d="M14.9224 38.7039C15.9157 39.2825 15.9157 40.7175 14.9224 41.2961L3.72971 47.8164C2.72972 48.3989 1.47467 47.6776 1.47467 46.5203V33.4797C1.47467 32.3224 2.72972 31.6011 3.72971 32.1836L14.9224 38.7039Z" stroke="#F1CD21"/>
                </svg>
            </div>
            <h3 class="section-content__row-text">В этом задании мы просим вас рассказать нам о тех профессиях, которые точно «не ваши».<br>И обосновать: почему вы бы не хотели работать именно в этих профессиях.<br>Вам необходимо составить список из <span>10 «не ваших»</span> профессий с объяснением, что вам в них не нравится. В примере ниже вариант одного из ответов на это задание.</h3>
        </div>

        <div class="section-content-block">
            <h3>Бухгалтерия. Мне не нравится однообразный и монотонный вид этой работы. Не люблю возиться с цифрами и таблицами. Плюс здесь мало общения с людьми. И большая ответственность - надо все посчитать правильно до копейки (а я часто путаюсь в цифрах и допускаю ошибки в расчетах).</h3>
        </div>

        <div class="section-content__row">
            <div class="section-content__row-image">
                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="50" viewBox="0 0 52 50" fill="none">
                    <path d="M20.5312 9.84375C20.5312 14.9968 16.2854 19.1875 11.0312 19.1875C5.77709 19.1875 1.53125 14.9968 1.53125 9.84375C1.53125 4.69073 5.77709 0.5 11.0312 0.5C16.2854 0.5 20.5312 4.69073 20.5312 9.84375Z" fill="#BD92CE" stroke="#BD92CE"/>
                    <rect x="31.7383" y="0.5" width="19.1416" height="19" rx="1.5" fill="#66CAA5" stroke="#66CAA5"/>
                    <path d="M15.3866 38.6937C16.4036 39.2676 16.4036 40.7324 15.3866 41.3063L3.73593 47.8812C2.736 48.4455 1.49872 47.723 1.49872 46.5748V33.4252C1.49872 32.277 2.736 31.5545 3.73593 32.1188L15.3866 38.6937Z" stroke="#F1CD21"/>
                </svg>
            </div>
            <h3 class="section-content__row-text">Пожалуйста, постарайтесь не вносить в этот список профессии, которые очевидно не нравятся всем. Например, «дворник» или «водитель машины по вывозу мусора». Подумайте про те профессии, которые нравятся некоторым людям (например, вашим знакомым) или вам их даже иногда рекомендуют, но вам  (по вашим ощущениям) они не подходят.</h3>
        </div>

        <div class="section-content__row">
            <div class="section-content__row-image">
                <svg xmlns="http://www.w3.org/2000/svg" width="52" height="50" viewBox="0 0 52 50" fill="none">
                    <path d="M20.5234 9.84375C20.5234 14.9968 16.2776 19.1875 11.0234 19.1875C5.76928 19.1875 1.52344 14.9968 1.52344 9.84375C1.52344 4.69073 5.76928 0.5 11.0234 0.5C16.2776 0.5 20.5234 4.69073 20.5234 9.84375Z" fill="#BD92CE" stroke="#BD92CE"/>
                    <rect x="31.5234" y="0.5" width="19" height="19" rx="1.5" fill="#66CAA5" stroke="#66CAA5"/>
                    <path d="M15.2872 38.6959C16.299 39.2709 16.299 40.7291 15.2872 41.3041L3.73947 47.867C2.73951 48.4353 1.49832 47.7131 1.49832 46.5629V33.4371C1.49832 32.2869 2.73951 31.5647 3.73948 32.133L15.2872 38.6959Z" fill="#F1CD21" stroke="#F1CD21"/>
                </svg>
            </div>
            <h3 class="section-content__row-text">И самое главное в этом задании - <span>подумайте и пропишите подробно</span>, что именно вам не нравится  в той или иной профессии. Почему вас отталкивает та или иная профессия из вашего списка? Из-за чего  вы решили именно эту профессию внести в ваш "Антирейтинг  профессий"</h3>
        </div>

        <!-- Инпуты в конце -->
        <div class="section-inputs">
            <div class="section-inputs__block">
                <h3>1.</h3>
                <textarea id="input-1" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>2.</h3>
                <textarea id="input-2" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>3.</h3>
                <textarea id="input-3" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>4.</h3>
                <textarea id="input-4" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>5.</h3>
                <textarea id="input-5" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>6.</h3>
                <textarea id="input-6" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>7.</h3>
                <textarea id="input-7" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>8.</h3>
                <textarea id="input-8" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>9.</h3>
                <textarea id="input-9" maxlength="1000"></textarea>
            </div>
            <div class="section-inputs__block">
                <h3>10.</h3>
                <textarea id="input-10" maxlength="1000"></textarea>
            </div>
        </div>


        <!-- Кнопки в конце -->
        <button id="button-end" disabled>Отправить</button>
        <button id="button-back">Назад</button>
    </section>
</article>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    // Пометить инпут ошибкой
    function inputError(selector) {
        // Если у инпута нету класса ошибки - добавляем и через 2 секунды удаляем
        if (!$(selector).hasClass("error")) {
            $(selector).addClass("error")
            setTimeout(() => {$(selector).removeClass("error")}, 2000)
        }
    }


    // Если пользователь валидно заполнил форму и данные сохранились в хэш, то заполняем поля
    let hashUserFormData = JSON.parse(localStorage.getItem("userFormData"))
    if (hashUserFormData) {
        $("#form-name").val(hashUserFormData.formName)
        $("#form-phone").val(hashUserFormData.formPhone)
        $("#form-email").val(hashUserFormData.formEmail)
        // Активируем галочку
        $("#policy").toggleClass("checked")
    }


    $("#form-name").change(() => { // Удаление лишних пробелов
        $("#form-name").val($("#form-name").val().replace(/ +/g, ' ').trim())
    })

    $("#form-phone").change(() => { // Удаление пробелов
        $("#form-phone").val($("#form-phone").val().replace(/ /g,''))
    })

    $("#form-email").change(() => { // Удаление пробелов
        $("#form-email").val($("#form-email").val().replace(/ /g,''))
    })


    // Галочка 
    $("#policy").on("click tap", () => {
        $("#policy").toggleClass("checked")
    })

    // Клик тексту после галочки
    $("#label-policy").on("click tap", () => {
        $("#policy").addClass("checked")
    })

    // Клик по политике
    $("#label-policy span").on("click tap", () => {
        window.open("../policy", "_blank")
    })


    // Ивент submit у формы входа
    const form = document.querySelector('form')
    form.addEventListener('submit', (event) => {
        // Отключение базового перехода
        event.preventDefault()

        // Отключаем кнопку на 2 секунды
        $("#submit-form").attr("disabled", "disabled")
        setTimeout(() => {
            $("#submit-form").removeAttr("disabled")
        }, 2000)


        // Получаем поля из фомы
        const formData = new FormData(form)
        const formName = formData.get("form-name")
        const formPhone = formData.get("form-phone")
        const formEmail = formData.get("form-email")
        
        // В поле ФИО должно быть ровно 3 слова
        if (formName.split(" ").length !== 3) {
            inputError("#form-name")

            // Ставим текст ошибки
            $("#form-error").text("Неверный формат ФИО")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        // Проверка поля Телефона на регулрном выражении
        let rePhone = /^[\d\+][\d\(\)\ -]{9,14}\d$/
        if (!rePhone.test(formPhone)) {
            inputError("#form-phone")
            // Ставим текст ошибки
            $("#form-error").text("Неверный номер телефона")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        // Проверка поля Почты на регулрном выражении
        let reEmail = /^[\w-\.]+@[\w-]+\.[a-z]{2,4}$/i
        if (!reEmail.test(formEmail)) {
            inputError("#form-email")
            // Ставим текст ошибки
            $("#form-error").text("Неверный email")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        if (!$("#policy").hasClass("checked")) {
            // Ставим текст ошибки
            $("#form-error").text("Отметьте поле")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }


        $("#form-aside").addClass("hidden")
        $("#form-section").addClass("hidden")
        $("#section-title").removeClass("hidden")
        $("#section-content").removeClass("hidden")

        // Класс для корректного отображения
        $("article").addClass("article-content")



        // Сохраняем информацию в хэш
        let userFormData = {
            formName: formName,
            formPhone: formPhone,
            formEmail: formEmail,
        }

        localStorage.setItem("userFormData", JSON.stringify(userFormData))

        // Когда заполнили все поля и нажали "Далее", то рендерит Правила
    })
</script>

<script>
    // Вернуться обратно в форму
    $("#button-back").on("click tap", () => {
        $("#form-aside").removeClass("hidden")
        $("#form-section").removeClass("hidden")
        $("#section-title").addClass("hidden")
        $("#section-content").addClass("hidden")

        // Класс для корректного отображения
        $("article").removeClass("article-content")
    })


    // Автозаполнение полей с ответами
    if (isQuestionsHash) {
        for (inputId in questionsHash) {
            $("#" + inputId).val(questionsHash[inputId])
        }
    }


    // Сохранение ответов
    $(".section-inputs__block textarea").on("input", (event) => {
        let inputId = event.currentTarget.id
        questionsHash[inputId] = $("#" + inputId).val()

        // Сохраняем ответы после записи
        localStorage.setItem("questionsHash_antiratingOfProfessions", JSON.stringify(questionsHash))


        // Если всего ответов 10
        if (Object.keys(questionsHash).length === 10) {
            // Если нету пустых ответов
            if (!Object.values(questionsHash).includes("")) {
                $("#button-end").removeAttr("disabled")
            } else {
                // Если есть, то ставим кнопку неактивной
                $("#button-end").attr("disabled", "disabled")
            }
        }
    })

    $(".section-inputs__block textarea").change((event) => {
        $("#" + event.currentTarget.id).val($("#" + event.currentTarget.id).val().replace(/ +/g, ' ').trim())
    })

    // Триггерим инпуты, что бы при заполненых ответах кнопка разблокировалась
    $(".section-inputs__block textarea").trigger("input")


    // Отправка ответов
    $("#button-end").on("click tap", () => {
        $("#button-end").attr("disabled", "disabled")
        setTimeout(() => {
            $("#button-end").removeAttr("disabled")
        }, 5000)


        // Получаем информацию о пользователе
        let userFormData = JSON.parse(localStorage.getItem("userFormData"))
        
        // Массив который отправиться
        let sendData = {
        // id: Установиться в google scripts
            "manager_id": parseInt(URLParams["manager-id"]),
            "name": userFormData.formName,
            "phone": userFormData.formPhone,
            "email": userFormData.formEmail,
            "new": true,
            "result": {
                "diagnostic-id": 8, // Для этой диагностики id = 8 (Взрослая версия)
                "data": questionsHash,
                "date": Date.now() // Дата текущего прохождения
            },
            "in_archive": false,
            "date": Date.now() // Дата последней активности
        }

        
        // Api запрос в таблицу с результатами
        function DBsendResults(data, func) {
            $.ajax({
                url: "https://planb-service.ru/api/v1/client/result",
                method: "POST",
                data: JSON.stringify(data),
                success: func
            })
        }

        DBsendResults(sendData, (data) => {
            // Информация отправляется и перекидывает на конец тестирования

            // Добавляем значение в хэш что бы после перезагрузки перекинуло на концовку
            localStorage.setItem("test-end", "test-end")
            location.reload()
        })
    })
</script>