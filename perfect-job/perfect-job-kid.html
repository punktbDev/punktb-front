<script>
    // Детская версия
    // Перекидываем на конец теста если есть значение
    if (localStorage.getItem("test-end")) {
        location.href = "../testing-end?test-name=perfectJobKid"
    }
</script>

<script>
    // Меняем название страницы
    document.title = "Идеальная работа"

    // Если нету manager-id В ссылке то перекинет на страницу с просьбой получить актуальную ссылку
    let URLParams = Object.fromEntries(new URLSearchParams(window.location.search))
    // Если в строке нету значения manager-id или он не цифра или значение пустое
    if (!URLParams.hasOwnProperty("manager-id") || isNaN(URLParams["manager-id"]) || URLParams["manager-id"] === "") {
        location.href = "../testing-end?no-manager-id=true"
    }

    // Получем сохраненные данные о тестировании
    let questionsHash = JSON.parse(localStorage.getItem("questionsHash_perfectJobKid"))
    let isQuestionsHash = questionsHash ? true : false // Была ли информация взята из кэша

    // Если объект = null - делаем его пустым объектом
    if (!isQuestionsHash) {
        questionsHash = {}
    }
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');

    :root {
        --p-gray: #00000088;
        --p-cian: #66CAA5;
        --h-title: #BD92CE;

        --border: #BD92CE;
        --border-cian: #66CAA6;
        --button: #BD92CE;
        --input-bg: #DEC8E7;
        --input-placeholder: #5E4967;

        --dot-bg: #F1CD21;


        --progress-width: 100%;
    }
    
    body {
        width: 100%;
    }
    
    h2 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 500;
        font-size: 48px;
        line-height: 134%;
    }
    
    h3 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 500;
        font-size: 24px;
        line-height: 132%;
    }
    
    p, .p1 {
        font-family: 'Roboto', Sans-Serif;
        font-weight: 400;
        font-size: 20px; /* На этой странице 20 вместо 18 */
        line-height: 21px;
    }

    .p1-strong {
        font-family: 'Roboto';
        font-weight: 500;
        font-size: 18px;
        line-height: 112%;
    }

    .p-gray {
        color: var(--p-gray);
    }

    .p-cut {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .hidden {
        display: none !important;
    }


    /* Стиль для ошибки инпута */
    input.error {
        animation: inputError 2s ease-in;
    }

    /* Анимацция ошибки */
    @keyframes inputError {
        0% {
            border: 1px solid var(--border);
        }

        2% {
            border: 1px solid #F40B0B;
        }

        100% {
            border: 1px solid var(--border);
        }
    }
</style>

<style>
    /* Логотип сверху слево */
    #top-left-logo {
        width: 128px;
        
        position: absolute;
        top: 50px;
        left: 100px;
        
    }
    
    #top-left-logo img {
        width: 100%;
    }
</style>
    
<style>
    article {
        width: min(1440px, 100%); /* Ширина 1440px или 100% при сужении */
        height: 800px;
        display: flex;
        flex-direction: row;
        justify-content: center;
        position: relative;
        
        margin: 0 auto; /* По центру страницы */
    }
    
    
    #form-aside {
        width: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
        gap: 12px;
    }


    #form-aside h3 {
        width: 403px;
        height: 96px;

        margin-right: 126px;
    }

    #form-aside p {
        width: 403px;
        height: 154px;

        font-size: 20px;
        line-height: 112%;

        margin-right: 126px;
    }

    #form-aside h3 span, #form-aside p span {
        color: var(--p-cian);
    }
</style>

<style>
    #form-section {
        width: 50%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    #form-section form {
        width: 460px;
        box-sizing: border-box;
        padding: 42px 65px;

        display: flex;
        flex-direction: column;
       
        border: 1px solid var(--border);
        border-radius: 10px;

        margin-left: 67px;
    }


    #form-logo {
        width: 100%;
        height: 29px;
        display: flex;
        justify-content: center;

        margin-bottom: 42px;
    }
    
    #form-logo img {
        width: 39px;
        height: 29px;
    }


    form input {
        display: block;
        width: 100%;
        height: 40px;
        box-sizing: border-box;
        padding: 0 12px;

        border: 1px solid var(--border);
        border-radius: 10px;

        margin-top: 4px;
        margin-bottom: 29px;
    }

    #form-error {
        color: #F40B0B;
        margin-bottom: 12px;
        visibility: hidden;
    }

    #form-error.show {
        visibility: visible;
    }

    button {
        width: 100%;
        height: 40px;
        box-sizing: border-box;

        font-size: 18px !important;

        display: flex;
        justify-content: center;
        align-items: center;

        background: var(--button);
        border-radius: 10px;
        border: none;
        outline: none;       
        
        transition: .15s all;
        cursor: pointer;
        color: #000000 !important;
    }
    
    @media (hover: hover) {
        button:hover {
            background: #000000;
            color: #FFFFFF !important;
        }
    }
    
    button:disabled {
        background: #d1aedf;
        color: #313131 !important;
        cursor: not-allowed;
    }
</style>

<style>
    input[type="email"] {
        margin-bottom: 12px;
    }


    /* Обработка персональной информации */
    .form-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 12px;

        margin-bottom: 20px;
    }

    #label-policy {
        width: calc(100% - 12px - 15px);
        font-size: 12px;
        line-height: 112%;
        cursor: pointer;
    }

    #label-policy span {
        font-size: 12px;
        line-height: 112%;
        cursor: pointer;
        display: inline;

        font-weight: 500;
        color: var(--h-title);
    }

    @media (hover: hover) {
        #label-policy span:hover {
            text-decoration: underline;
        }
    }

    @media (hover: none) {
        #label-policy span {
            text-decoration: underline;
        }
    }

    #policy {
        width: 15px;
        height: 15px;
        box-sizing: border-box;
        cursor: pointer;

        border-radius: 3px;
        border: 1px solid var(--border);
        background-color: #ffffff;

    }

    #policy.checked {
        background-color: var(--border);
    }
</style>

<style>
    .article-content {
        height: auto;
        flex-direction: column;
        position: relative;

        box-sizing: border-box;
        padding: 0 80px 70px 80px; /* На 70px снизу меньше так как снизу плашка от тильды */
    }


    #section-content {
        width: 100%;
        height: auto;
        display: flex;
        flex-direction: row;
        gap: 30px;
    }

    /* Заголовок страницы */
    #section-title {
        height: 60px;
        padding-top: 75px;
        padding-bottom: 120px;

        text-transform: uppercase;
        text-align: center;
    }



    /* Правила */
    .section-rules {
        width: 55%;
        position: relative;
    }


    /* Инпуты */
    .section-inputs {
        width: 546px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .section-inputs__block {
        width: 100%;
        height: 60px;
        position: relative;
    }

    .section-inputs__block h3 {
        position: absolute;
        top: 14px;
        left: 20px;

        font-size: 24px;
    }

    .section-inputs input {
        width: 100%;
        height: 100%;

        box-sizing: border-box;
        padding: 14px 20px 14px 60px;

        border: 2px solid var(--border);
        border-radius: 10px;

        color: #000000;
        font-family: 'Roboto', Sans-Serif;
        font-size: 24px;
        font-style: normal;
        font-weight: 400;
        line-height: 132%;

        margin: 0;
    }


    #button-end, #button-back {
        width: 100%;
        height: 60px;

        border-radius: 10px;

        font-size: 24px !important;
        font-weight: 500;

        margin-top: 20px;
    }

    #button-back {
        margin-top: 0px;
    }


    .section-rules h3 {
        font-size: 16px;
        font-weight: 400;
    }

    .section-rules h3 span {
        font-weight: 700;
    }

    .section-rules__square {
        width: 300px;
        height: 300px;
        box-sizing: border-box;
        padding: 40px 13px 0 12px;

        border-radius: 20px;
        background: var(--border);

        position: absolute;
        top: 4px;
        left: 152px;
        z-index: 1;
    }

    .section-rules__square h3:nth-child(1) {
        text-align: center;

        margin-bottom: 20px;
    }

    .section-rules__circle {
        width: 314.685px;
        height: 300px;
        box-sizing: border-box;
        padding: 77px 46px 0 46px;

        border-radius: 314.685px;
        background: var(--dot-bg);

        position: absolute;
        top: 204px;
        left: 8px;
        z-index: 2;
    }

    .section-rules__triangle {
        width: 346.41px;
        height: 300px;

        position: absolute;
        top: 424px;
        left: 169px;
    }

    .section-rules__triangle h3:nth-child(1) {
        width: 148px;
        position: absolute;
        top: 101px;
        left: 16px;
        z-index: 4;
    }

    .section-rules__triangle h3:nth-child(2) {
        width: 67px;
        position: absolute;
        top: 178px;
        left: 48px;
        z-index: 4;
    }

    .section-rules__triangle svg {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 3;
    }


    /* Аудиоплеер */
    .audio-wrapper {
        width: 100%;
        height: 49px;
        display: flex;
        align-items: center;
    }

    #audio-play {
        width: 28px;
        height: 28px;
        display: flex;
        justify-content: center;
        align-items: center;

        background: #00000000;
        border: none;
        border-radius: 0px;
        outline: none;

        margin-right: 20px;
    }

    #audio-play.play {
        content: url("https://sun9-61.userapi.com/impg/WQpTXyzAWt4YZQVkQ6DsNowrzfaUwUPALOm68g/76RoXnEKYfs.jpg?size=21x34&quality=96&sign=3b180872d11835e802b240ba5b2ebfa1&type=album");
    }

    #audio-progress {
        position: relative;
        width: 498px;
        height: 44px;

        cursor: pointer;
    }

    #audio-progress::after {
        content: "";
        width: var(--progress-width);
        height: 100%;
        position: absolute;
        top: 0;
        right: 0;
        background-color: #ffffff88;
    }
</style>

<article>
    <div id="top-left-logo">
        <img src="https://static.tildacdn.com/tild6630-3237-4638-a534-313664333931/___.svg" alt="logo">
    </div>
    
    <aside id="form-aside">
        <h3>После заполнения анкеты вам откроется доступ к диагностике<br><span>«Идеальная работа»</span></h3>
        <p>Диагностика поможет узнать, какие виды деятельности вам подходят больше всего.<br>Пожалуйста, внимательно прочитайте инструкцию, прежде чем переходить к самой диагностике. Инструкция будет доступна вам после заполнения данной формы.</p>
    </aside>

    <section id="form-section">
        <form>
            <div id="form-logo">
                <img src="https://sun9-33.userapi.com/impg/o7UasFLuPHffAw7M354dhIyAw-ywr1TdpgWp7w/AU35d9CQutY.jpg?size=192x140&quality=96&sign=65f29d920ee520f801e55492621ceaed&type=album" alt="mini-logo">
            </div>

            <label class="p1" for="form-name">ФИО</label>
            <input class="p1" type="text" id="form-name" name="form-name" maxlength="100" required>

            <label class="p1" for="form-phone">Телефон</label>
            <input class="p1" type="tel" id="form-phone" name="form-phone" maxlength="20" required>

            <label class="p1" for="form-email">Email</label>
            <input class="p1" type="email" id="form-email" name="form-email" maxlength="100" required>

            <p id="form-error">Неверный формат ФИО</p>

            <div class="form-checkbox">
                <div id="policy"></div>
                <label id="label-policy" for="policy" class="p1">Я принимаю условия <span>Пользовательского соглашения</span> и даю свое <span>согласие на обработку персональных данных</span> в соответствии с <span>Политикой</span>.</label>
            </div>
            

            <button class="p1" type="submit" id="submit-form">Далее</button>
        </form>
    </section>


    <!-- Контент диагностики -->
    <h2 id="section-title" class="hidden">«Идеальная работа»</h2>
    <section id="section-content" class="hidden">
        <!-- Две колонны контента -->
        <div class="section-rules">
            <div class="section-rules__square">
                <h3><span>Привествуем!</span></h3>
                <h3>Пожалуйста, внимательно <span>до конца</span> дослушай аудио с заданием, прежде чем что-либо делать. Это важно сделать, чтобы правильно выполнить задание!</h3>
            </div>

            <div class="section-rules__circle">
                <h3>Не обязательно, <span>но рекомендую</span> тебе при выполнении этого задания узнать опыт твоего окружения. Какая работа для них идеальна? И почему?</h3>
            </div>

            <div class="section-rules__triangle">
                <h3>Жду выполненное задание до <span>21:00</span> завтрашнего дня!</h3>
                <h3><span>УДАЧИ!</span></h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="280" height="318" viewBox="0 0 280 318" fill="none">
                    <path d="M270 141.885C283.333 149.583 283.333 168.828 270 176.526L30 315.09C16.6667 322.788 0 313.165 0 297.769V20.641C0 5.24501 16.6667 -4.3775 30 3.32051L270 141.885Z" fill="#66CAA5"/>
                </svg>
            </div>
        </div>
        
        <div class="section-inputs">
            <!-- Вопроизведение голосового сообщения -->
            <div class="audio-wrapper">
                <!-- Тег Audio дял воспроизведения -->
                <audio class="audio" src="https://drive.google.com/uc?export=download&confirm=no_antivirus&id=1qp0EfblraA8S1OVlxTehydqS9Wv_jusr"></audio>
                
                <!-- Кнопка старта и паузы -->
                <button id="audio-play">
                    <img src="https://sun9-66.userapi.com/impg/bZIvIeta5p67wIH-4hlex3TdFBr5LELvUrr7jA/KMC199jejKs.jpg?size=28x28&quality=96&sign=b8e587bf5ee368c11fbc25b9f8c2e046&type=album" alt="button">
                </button>
                
                <!-- Прогресс вопроизведения -->
                <div id="audio-progress">
                    <img src="https://sun9-39.userapi.com/impg/SaJTJ29rLHokeXCRFvSQ4y_3P3k5wm1epeSBNw/Ok7Qeih2XNk.jpg?size=498x44&quality=96&sign=72d47dcfec1db3311575b62db8b8ace5&type=album" alt="audio">
                </div>
            </div>

            <div class="section-inputs__block">
                <h3>1.</h3>
                <input type="text" id="input-1" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>2.</h3>
                <input type="text" id="input-2" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>3.</h3>
                <input type="text" id="input-3" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>4.</h3>
                <input type="text" id="input-4" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>5.</h3>
                <input type="text" id="input-5" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>6.</h3>
                <input type="text" id="input-6" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>7.</h3>
                <input type="text" id="input-7" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>8.</h3>
                <input type="text" id="input-8" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>9.</h3>
                <input type="text" id="input-9" maxlength="100">
            </div>
            <div class="section-inputs__block">
                <h3>10.</h3>
                <input type="text" id="input-10" maxlength="100">
            </div>


            <!-- Кнопки в конце -->
            <button id="button-end" disabled>Отправить</button>
            <button id="button-back">Назад</button>
        </div>

        
    </section>
</article>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    // Пометить инпут ошибкой
    function inputError(selector) {
        // Если у инпута нету класса ошибки - добавляем и через 2 секунды удаляем
        if (!$(selector).hasClass("error")) {
            $(selector).addClass("error")
            setTimeout(() => {$(selector).removeClass("error")}, 2000)
        }
    }


    // Если пользователь валидно заполнил форму и данные сохранились в хэш, то заполняем поля
    let hashUserFormData = JSON.parse(localStorage.getItem("userFormData"))
    if (hashUserFormData) {
        $("#form-name").val(hashUserFormData.formName)
        $("#form-phone").val(hashUserFormData.formPhone)
        $("#form-email").val(hashUserFormData.formEmail)
        // Активируем галочку
        $("#policy").toggleClass("checked")
    }


    $("#form-name").change(() => { // Удаление лишних пробелов
        $("#form-name").val($("#form-name").val().replace(/ +/g, ' ').trim())
    })

    $("#form-phone").change(() => { // Удаление пробелов
        $("#form-phone").val($("#form-phone").val().replace(/ /g,''))
    })

    $("#form-email").change(() => { // Удаление пробелов
        $("#form-email").val($("#form-email").val().replace(/ /g,''))
    })


    // Галочка 
    $("#policy").on("click tap", () => {
        $("#policy").toggleClass("checked")
    })

    // Клик тексту после галочки
    $("#label-policy").on("click tap", () => {
        $("#policy").addClass("checked")
    })

    // Клик по политике
    $("#label-policy span").on("click tap", () => {
        window.open("../policy", "_blank")
    })


    // Ивент submit у формы входа
    const form = document.querySelector('form')
    form.addEventListener('submit', (event) => {
        // Отключение базового перехода
        event.preventDefault()

        // Отключаем кнопку на 2 секунды
        $("#submit-form").attr("disabled", "disabled")
        setTimeout(() => {
            $("#submit-form").removeAttr("disabled")
        }, 2000)


        // Получаем поля из фомы
        const formData = new FormData(form)
        const formName = formData.get("form-name")
        const formPhone = formData.get("form-phone")
        const formEmail = formData.get("form-email")
        
        // В поле ФИО должно быть ровно 3 слова
        if (formName.split(" ").length !== 3) {
            inputError("#form-name")

            // Ставим текст ошибки
            $("#form-error").text("Неверный формат ФИО")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        // Проверка поля Телефона на регулрном выражении
        let rePhone = /^[\d\+][\d\(\)\ -]{9,14}\d$/
        if (!rePhone.test(formPhone)) {
            inputError("#form-phone")
            // Ставим текст ошибки
            $("#form-error").text("Неверный номер телефона")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        // Проверка поля Почты на регулрном выражении
        let reEmail = /^[\w-\.]+@[\w-]+\.[a-z]{2,4}$/i
        if (!reEmail.test(formEmail)) {
            inputError("#form-email")
            // Ставим текст ошибки
            $("#form-error").text("Неверный email")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }

        if (!$("#policy").hasClass("checked")) {
            // Ставим текст ошибки
            $("#form-error").text("Отметьте поле")
            $("#form-error").addClass("show")
            setTimeout(() => {
                $("#form-error").removeClass("show")
            }, 2000)
            return
        }


        $("#form-aside").addClass("hidden")
        $("#form-section").addClass("hidden")
        $("#section-title").removeClass("hidden")
        $("#section-content").removeClass("hidden")

        // Класс для корректного отображения
        $("article").addClass("article-content")



        // Сохраняем информацию в хэш
        let userFormData = {
            formName: formName,
            formPhone: formPhone,
            formEmail: formEmail,
        }

        localStorage.setItem("userFormData", JSON.stringify(userFormData))

        // Когда заполнили все поля и нажали "Далее", то рендерит Правила
    })
</script>

<script>
    // Вернуться обратно в форму
    $("#button-back").on("click tap", () => {
        $("#form-aside").removeClass("hidden")
        $("#form-section").removeClass("hidden")
        $("#section-title").addClass("hidden")
        $("#section-content").addClass("hidden")

        // Класс для корректного отображения
        $("article").removeClass("article-content")
    })


    // Автозаполнение полей с ответами
    if (isQuestionsHash) {
        for (inputId in questionsHash) {
            $("#" + inputId).val(questionsHash[inputId])
        }
    }


    // Сохранение ответов
    $(".section-inputs__block input").on("input", (event) => {
        let inputId = event.currentTarget.id
        questionsHash[inputId] = $("#" + inputId).val()

        // Сохраняем ответы после записи
        localStorage.setItem("questionsHash_perfectJobKid", JSON.stringify(questionsHash))


        // Если всего ответов 10
        if (Object.keys(questionsHash).length === 10) {
            // Если нету пустых ответов
            if (!Object.values(questionsHash).includes("")) {
                $("#button-end").removeAttr("disabled")
            } else {
                // Если есть, то ставим кнопку неактивной
                $("#button-end").attr("disabled", "disabled")
            }
        }
    })

    $(".section-inputs__block input").change((event) => {
        $("#" + event.currentTarget.id).val($("#" + event.currentTarget.id).val().replace(/ +/g, ' ').trim())
    })

    // Триггерим инпуты, что бы при заполненых ответах кнопка разблокировалась
    $(".section-inputs__block input").trigger("input")


    // Отправка ответов
    $("#button-end").on("click tap", () => {
        $("#button-end").attr("disabled", "disabled")
        setTimeout(() => {
            $("#button-end").removeAttr("disabled")
        }, 5000)

        // Проверка, если не все поля заполнены
        if (Object.values(questionsHash).includes("")) {
           return
        }

        // Получаем информацию о пользователе
        let userFormData = JSON.parse(localStorage.getItem("userFormData"))
        
        // Массив который отправиться
        let sendData = {
        // id: Установиться в google scripts
            "manager_id": parseInt(URLParams["manager-id"]),
            "name": userFormData.formName,
            "phone": userFormData.formPhone,
            "email": userFormData.formEmail,
            "new": true,
            "result": {
                "diagnostic-id": 3, // Для этой диагностики id = 3 (Детская версия)
                "data": questionsHash,
                "date": Date.now() // Дата текущего прохождения
            },
            "in_archive": false,
            "date": Date.now() // Дата последней активности
        }
        
        // Api запрос в таблицу с результатами
        function DBsendResults(data, func) {
            $.ajax({
                url: "https://planb-service.ru/api/v1/client/result",
                method: "POST",
                data: JSON.stringify(data),
                success: func
            })
        }

        DBsendResults(sendData, (data) => {
            // Информация отправляется и перекидывает на конец тестирования

            // Добавляем значение в хэш что бы после перезагрузки перекинуло на концовку
            localStorage.setItem("test-end", "test-end")
            location.reload()
        })
    })
</script>

<script>
    // Воспроизведение гс
    let audio = $(".audio")[0]
    audio.muted  = false
    audio.volume = 0.5

    $("#audio-play").on("click tap", () => {
        if (!$("#audio-play").hasClass("play")) {
            audio.play()
        } else {
            audio.pause()
        }
        
        // Меняем иконку
        $("#audio-play").toggleClass("play")
    })
    

    // Окончание звуковой дорожки
    audio.addEventListener('ended', () => {
        // Меняем иконку
        $("#audio-play").toggleClass("play")
        $("#audio-progress").css("--progress-width", "100%")

    })

    audio.addEventListener("timeupdate", (event) => {
        $("#audio-progress").css("--progress-width", 100 - (event.target.currentTime / event.target.duration * 100) + "%")
    })

    $("#audio-progress").on("click tap", (event) => {
        let width = $("#audio-progress")[0].clientWidth
        let clickX = event.offsetX
        let duration = audio.duration

        audio.currentTime = (clickX / width) * duration
    })
</script>